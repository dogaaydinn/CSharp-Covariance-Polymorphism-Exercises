name: Release Management

on:
  push:
    tags:
      - 'v*.*.*'  # Trigger on version tags like v1.0.0
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 1.0.0)'
        required: true
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        type: boolean
        default: false

env:
  DOTNET_VERSION: '8.0.x'
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 'true'
  DOTNET_CLI_TELEMETRY_OPTOUT: 'true'

permissions:
  contents: write
  packages: write
  pull-requests: write

jobs:
  validate-version:
    name: Validate Release Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-version.outputs.version }}
      is_prerelease: ${{ steps.get-version.outputs.is_prerelease }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version
        id: get-version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
            IS_PRERELEASE="${{ github.event.inputs.prerelease }}"
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
            if [[ "$VERSION" =~ -[a-zA-Z] ]]; then
              IS_PRERELEASE="true"
            else
              IS_PRERELEASE="false"
            fi
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
          echo "Release version: $VERSION"
          echo "Is prerelease: $IS_PRERELEASE"

      - name: Validate version format
        run: |
          VERSION="${{ steps.get-version.outputs.version }}"
          if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+(\.[0-9]+)?)?$ ]]; then
            echo "âŒ Invalid version format: $VERSION"
            echo "Expected format: X.Y.Z or X.Y.Z-prerelease"
            exit 1
          fi
          echo "âœ… Version format is valid"

  build-artifacts:
    name: Build Release Artifacts
    runs-on: ubuntu-latest
    needs: validate-version

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore dependencies
        run: dotnet restore

      - name: Build solution
        run: |
          dotnet build \
            --configuration Release \
            --no-restore \
            /p:Version=${{ needs.validate-version.outputs.version }} \
            /p:AssemblyVersion=${{ needs.validate-version.outputs.version }} \
            /p:FileVersion=${{ needs.validate-version.outputs.version }}

      - name: Run tests
        run: |
          dotnet test \
            --configuration Release \
            --no-build \
            --verbosity normal \
            --logger "trx;LogFileName=test-results.trx" \
            --collect:"XPlat Code Coverage"

      - name: Pack NuGet packages
        run: |
          dotnet pack src/AdvancedConcepts.Core/AdvancedConcepts.Core.csproj \
            --configuration Release \
            --no-build \
            --output ./artifacts/packages \
            /p:PackageVersion=${{ needs.validate-version.outputs.version }}

          if [ -d "src/AdvancedConcepts.Analyzers" ]; then
            dotnet pack src/AdvancedConcepts.Analyzers/AdvancedConcepts.Analyzers.csproj \
              --configuration Release \
              --no-build \
              --output ./artifacts/packages \
              /p:PackageVersion=${{ needs.validate-version.outputs.version }}
          fi

      - name: Create release archives
        run: |
          mkdir -p ./artifacts/archives

          # Create source archive
          git archive --format=zip --prefix=advanced-csharp-concepts-${{ needs.validate-version.outputs.version }}/ HEAD > \
            ./artifacts/archives/advanced-csharp-concepts-${{ needs.validate-version.outputs.version }}-source.zip

          # Create binary archive
          cd src/AdvancedConcepts.Core/bin/Release/net8.0
          zip -r $GITHUB_WORKSPACE/artifacts/archives/advanced-csharp-concepts-${{ needs.validate-version.outputs.version }}-binaries.zip .
          cd $GITHUB_WORKSPACE

      - name: Generate checksums
        run: |
          cd ./artifacts
          find . -type f \( -name "*.nupkg" -o -name "*.zip" \) -exec sha256sum {} \; > checksums.txt
          cd ..

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts-${{ needs.validate-version.outputs.version }}
          path: ./artifacts/
          retention-days: 90

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [validate-version, build-artifacts]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-artifacts-${{ needs.validate-version.outputs.version }}
          path: ./artifacts

      - name: Generate release notes
        id: release-notes
        run: |
          VERSION="${{ needs.validate-version.outputs.version }}"

          # Try to get previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          # Generate changelog
          if [ -n "$PREV_TAG" ]; then
            CHANGELOG=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          else
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges | head -20)
          fi

          # Create release notes file
          cat > release-notes.md << 'EOFMARKER'
          ## Advanced C# Concepts - Release
          EOFMARKER

          echo "" >> release-notes.md
          echo "### What's New" >> release-notes.md
          echo "" >> release-notes.md
          echo "$CHANGELOG" >> release-notes.md

          cat >> release-notes.md << 'EOFMARKER'

          ### Installation

          #### NuGet Package
          ```bash
          dotnet add package AdvancedConcepts.Core
          ```

          #### Source Code
          Download the source archive or clone the repository:
          ```bash
          git clone https://github.com/${{ github.repository }}.git
          ```

          ### What's Included

          - âœ… Core library with advanced C# concepts
          - âœ… Roslyn analyzers for code quality
          - âœ… Comprehensive samples and examples
          - âœ… Complete documentation
          - âœ… Unit and integration tests

          ### Documentation

          - [README](https://github.com/${{ github.repository }}/blob/main/README.md)
          - [Architecture Decision Records](https://github.com/${{ github.repository }}/tree/main/docs/architecture/01-architecture-decision-records)
          - [Samples](https://github.com/${{ github.repository }}/tree/main/samples)

          ### Requirements

          - .NET 8.0 or later
          - Visual Studio 2022 17.8+ or JetBrains Rider 2023.3+ (recommended)

          ### Checksums

          See `checksums.txt` for SHA256 checksums of all release artifacts.

          ---

          **Full Changelog**: https://github.com/${{ github.repository }}/compare/${PREV_TAG}...v${{ needs.validate-version.outputs.version }}
          EOFMARKER

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.validate-version.outputs.version }}
          name: Release ${{ needs.validate-version.outputs.version }}
          body_path: release-notes.md
          draft: false
          prerelease: ${{ needs.validate-version.outputs.is_prerelease == 'true' }}
          files: |
            ./artifacts/packages/*.nupkg
            ./artifacts/archives/*.zip
            ./artifacts/checksums.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-nuget:
    name: Publish to NuGet.org
    runs-on: ubuntu-latest
    needs: [validate-version, build-artifacts, create-release]
    if: needs.validate-version.outputs.is_prerelease == 'false'
    environment:
      name: nuget-production
      url: https://www.nuget.org/packages/AdvancedConcepts.Core

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-artifacts-${{ needs.validate-version.outputs.version }}
          path: ./artifacts

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Publish to NuGet.org
        run: |
          dotnet nuget push ./artifacts/packages/*.nupkg \
            --api-key ${{ secrets.NUGET_API_KEY }} \
            --source https://api.nuget.org/v3/index.json \
            --skip-duplicate
        env:
          NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}

      - name: Verify package publication
        run: |
          echo "âœ… Packages published to NuGet.org"
          echo "ðŸ“¦ Package URL: https://www.nuget.org/packages/AdvancedConcepts.Core/${{ needs.validate-version.outputs.version }}"

  publish-github-packages:
    name: Publish to GitHub Packages
    runs-on: ubuntu-latest
    needs: [validate-version, build-artifacts, create-release]

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-artifacts-${{ needs.validate-version.outputs.version }}
          path: ./artifacts

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Publish to GitHub Packages
        run: |
          dotnet nuget push ./artifacts/packages/*.nupkg \
            --api-key ${{ secrets.GITHUB_TOKEN }} \
            --source "https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json" \
            --skip-duplicate
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-docker:
    name: Publish Docker Images
    runs-on: ubuntu-latest
    needs: [validate-version, create-release]
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/aspire-video-service-api
          tags: |
            type=semver,pattern={{version}},value=${{ needs.validate-version.outputs.version }}
            type=semver,pattern={{major}}.{{minor}},value=${{ needs.validate-version.outputs.version }}
            type=raw,value=latest,enable=${{ needs.validate-version.outputs.is_prerelease == 'false' }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./samples/07-CloudNative/AspireVideoService
          file: ./samples/07-CloudNative/AspireVideoService/VideoService.API/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VERSION=${{ needs.validate-version.outputs.version }}
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}

  announce-release:
    name: Announce Release
    runs-on: ubuntu-latest
    needs: [validate-version, create-release, publish-nuget, publish-github-packages, publish-docker]
    if: always()

    steps:
      - name: Generate release summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ðŸŽ‰ Release Published

          ### Release Details
          - **Version**: ${{ needs.validate-version.outputs.version }}
          - **Type**: ${{ needs.validate-version.outputs.is_prerelease == 'true' && 'Pre-release' || 'Stable Release' }}
          - **Commit**: ${{ github.sha }}

          ### Published Packages
          - âœ… GitHub Release created
          - âœ… GitHub Packages published
          - ${{ needs.validate-version.outputs.is_prerelease == 'false' && 'âœ…' || 'â­ï¸' }} NuGet.org ${{ needs.validate-version.outputs.is_prerelease == 'false' && 'published' || 'skipped (pre-release)' }}
          - âœ… Docker images published

          ### Links
          - [GitHub Release](https://github.com/${{ github.repository }}/releases/tag/v${{ needs.validate-version.outputs.version }})
          - [NuGet Package](https://www.nuget.org/packages/AdvancedConcepts.Core/${{ needs.validate-version.outputs.version }})
          - [GitHub Packages](https://github.com/${{ github.repository_owner }}?tab=packages)

          ### Installation
          ```bash
          dotnet add package AdvancedConcepts.Core --version ${{ needs.validate-version.outputs.version }}
          ```
          EOF

      - name: Notify completion
        run: |
          echo "ðŸŽ‰ Release ${{ needs.validate-version.outputs.version }} completed successfully!"
          echo "ðŸ“¦ GitHub Release: https://github.com/${{ github.repository }}/releases/tag/v${{ needs.validate-version.outputs.version }}"
          if [ "${{ needs.validate-version.outputs.is_prerelease }}" = "false" ]; then
            echo "ðŸ“¦ NuGet: https://www.nuget.org/packages/AdvancedConcepts.Core/${{ needs.validate-version.outputs.version }}"
          fi
